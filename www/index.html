<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Journal Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* WhatsApp-like Background */
        body {
            background-color: #E5DDD5;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M15 15h10v10H15zM55 55h10v10H55zM85 15h10v10H85zM25 75h10v10H25z' fill='%23d1d7df' fill-opacity='0.4'/%3E%3C/svg%3E");
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden; /* Prevent body scroll, handle in chat container */
        }

        /* Message Bubble Tail */
        .message-out::after {
            content: "";
            position: absolute;
            top: 0px;
            right: -8px;
            width: 0;
            height: 0;
            border-top: 10px solid #d9fdd3;
            border-right: 10px solid transparent;
            filter: drop-shadow(1px 1px 1px rgba(0,0,0,0.1));
        }

        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        /* Long press selection prevention */
        .noselect {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* Action Sheet Animation */
        .sheet-up {
            transform: translateY(0%);
        }
        .sheet-down {
            transform: translateY(100%);
        }
    </style>
</head>
<body class="h-screen flex flex-col relative">

    <!-- Header -->
    <header class="bg-[#008069] text-white p-3 flex items-center shadow-md z-10 shrink-0">
        <div class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center mr-3">
            <i class="fas fa-book text-lg"></i>
        </div>
        <div>
            <h1 class="font-semibold text-lg">My Journal</h1>
            <p class="text-xs text-white/80" id="entry-count">0 entries</p>
        </div>
    </header>

    <!-- Chat Area -->
    <main id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-2 no-scrollbar scroll-smooth pb-24">
        <!-- Messages will be injected here -->
        <div id="empty-state" class="text-center mt-20 hidden">
            <div class="bg-[#e1f3fb] text-gray-600 text-xs py-2 px-4 rounded-lg inline-block shadow-sm">
                <i class="fas fa-lock text-[10px] mr-1"></i> Messages are stored locally on your device using IndexedDB.
            </div>
        </div>
    </main>

    <!-- Input Area -->
    <footer class="bg-[#f0f2f5] p-2 flex items-end gap-2 fixed bottom-0 w-full z-20 pb-safe shadow-inner">
        
        <!-- Date Picker (Hidden by default, triggered by icon or shown compact) -->
        <div class="flex flex-col gap-1 w-full">
            <div class="flex items-center gap-2 px-1">
                <input type="datetime-local" id="entry-date" class="text-xs bg-transparent text-gray-500 outline-none border-none p-0 w-auto">
                <span id="edit-indicator" class="hidden text-xs text-orange-600 font-bold animate-pulse">EDITING</span>
            </div>
            
            <div class="flex items-center gap-2 w-full">
                <div class="flex-1 bg-white rounded-2xl flex items-center px-4 py-2 shadow-sm border border-gray-100">
                    <textarea id="entry-text" rows="1" placeholder="Type a journal entry..." class="w-full outline-none resize-none bg-transparent text-gray-800 max-h-32 overflow-y-auto"></textarea>
                </div>
                
                <!-- Send/Update Button -->
                <button id="send-btn" class="w-12 h-12 bg-[#008069] rounded-full flex items-center justify-center text-white shadow-md active:scale-95 transition-transform shrink-0">
                    <i class="fas fa-paper-plane"></i>
                </button>
                 <!-- Cancel Edit Button (Hidden initially) -->
                 <button id="cancel-edit-btn" class="hidden w-12 h-12 bg-gray-500 rounded-full flex items-center justify-center text-white shadow-md active:scale-95 transition-transform shrink-0">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </footer>

    <!-- Long Press Action Sheet (Modal) -->
    <div id="action-sheet-overlay" class="fixed inset-0 bg-black/40 z-40 hidden transition-opacity opacity-0"></div>
    <div id="action-sheet" class="fixed bottom-0 left-0 right-0 bg-white rounded-t-2xl z-50 transition-transform duration-300 sheet-down pb-6 pt-2 px-4 shadow-2xl">
        <div class="w-12 h-1 bg-gray-300 rounded-full mx-auto mb-4 mt-2"></div>
        <h3 class="text-center text-gray-500 text-sm mb-4 font-medium">Message Options</h3>
        <div class="flex flex-col gap-2">
            <button id="action-edit" class="w-full bg-gray-100 p-3 rounded-lg text-gray-800 font-medium active:bg-gray-200 flex items-center gap-3">
                <i class="fas fa-pen text-blue-600"></i> Edit Entry
            </button>
            <button id="action-delete" class="w-full bg-red-50 p-3 rounded-lg text-red-600 font-medium active:bg-red-100 flex items-center gap-3">
                <i class="fas fa-trash"></i> Delete Entry
            </button>
            <button id="action-cancel" class="w-full p-3 rounded-lg text-gray-500 font-medium mt-2">
                Cancel
            </button>
        </div>
    </div>

    <script>
        // --- Configuration & State ---
        const DB_NAME = 'JournalDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'entries';
        
        let db;
        let editingId = null; // Tracks which ID we are editing, if any
        let longPressTimer;
        let selectedEntryId = null;

        // --- DOM Elements ---
        const chatContainer = document.getElementById('chat-container');
        const entryText = document.getElementById('entry-text');
        const entryDate = document.getElementById('entry-date');
        const sendBtn = document.getElementById('send-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const editIndicator = document.getElementById('edit-indicator');
        const emptyState = document.getElementById('empty-state');
        const entryCountLabel = document.getElementById('entry-count');

        // Action Sheet Elements
        const actionSheet = document.getElementById('action-sheet');
        const actionOverlay = document.getElementById('action-sheet-overlay');
        const actionEdit = document.getElementById('action-edit');
        const actionDelete = document.getElementById('action-delete');
        const actionCancel = document.getElementById('action-cancel');

        // --- Initialization ---
        window.onload = () => {
            initDB();
            setDefaultDateTime();
            adjustTextareaHeight();
        };

        // --- IndexedDB Logic ---
        function initDB() {
            const request = indexedDB.open(DB_NAME, DB_VERSION);

            request.onupgradeneeded = (e) => {
                db = e.target.result;
                if (!db.objectStoreNames.contains(STORE_NAME)) {
                    const objectStore = db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                    objectStore.createIndex('timestamp', 'timestamp', { unique: false });
                }
            };

            request.onsuccess = (e) => {
                db = e.target.result;
                loadEntries();
            };

            request.onerror = (e) => {
                console.error("Database error", e);
                alert("Error loading database. Please refresh.");
            };
        }

        function saveEntry() {
            const text = entryText.value.trim();
            const dateVal = entryDate.value;

            if (!text) return;

            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const store = transaction.objectStore(STORE_NAME);

            const entry = {
                content: text,
                timestamp: dateVal // Stores ISO string compatible format from input
            };

            let request;

            if (editingId) {
                // Update existing
                entry.id = editingId;
                request = store.put(entry);
            } else {
                // Add new
                request = store.add(entry);
            }

            request.onsuccess = () => {
                resetInput();
                loadEntries();
            };

            request.onerror = () => {
                alert("Failed to save entry.");
            };
        }

        function deleteEntry(id) {
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.delete(id);

            request.onsuccess = () => {
                loadEntries();
                closeActionSheet();
            };
        }

        function loadEntries() {
            const transaction = db.transaction([STORE_NAME], 'readonly');
            const store = transaction.objectStore(STORE_NAME);
            const index = store.index('timestamp');
            const request = index.getAll();

            request.onsuccess = () => {
                // Sort by date (IndexedDB sorts automatically by key, but let's ensure text format sorting matches expectations)
                const entries = request.result; 
                
                // Although index sorts, date strings work best if they are ISO. 
                // The input returns 'YYYY-MM-DDTHH:MM', which sorts correctly lexicographically.
                
                renderEntries(entries);
            };
        }

        // --- UI Rendering ---
        function renderEntries(entries) {
            chatContainer.innerHTML = '';
            
            if (entries.length === 0) {
                chatContainer.appendChild(emptyState);
                emptyState.classList.remove('hidden');
                entryCountLabel.innerText = "0 entries";
                return;
            } else {
                emptyState.classList.add('hidden');
            }

            entryCountLabel.innerText = `${entries.length} entries`;

            // Group messages by Date for visual separation (Like WhatsApp)
            let lastDate = '';

            entries.forEach(entry => {
                const entryDateObj = new Date(entry.timestamp);
                const dateStr = entryDateObj.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                
                // Date Separator
                if (dateStr !== lastDate) {
                    const dateDiv = document.createElement('div');
                    dateDiv.className = "flex justify-center my-4 sticky top-0 z-0";
                    dateDiv.innerHTML = `<span class="bg-[#e1f3fb] text-gray-600 text-xs py-1.5 px-3 rounded-lg shadow-sm font-medium uppercase tracking-wide opacity-90">${dateStr}</span>`;
                    chatContainer.appendChild(dateDiv);
                    lastDate = dateStr;
                }

                // Message Bubble
                const bubbleWrapper = document.createElement('div');
                bubbleWrapper.className = "flex justify-end mb-2 px-2 fade-in";
                
                const bubble = document.createElement('div');
                // WhatsApp-ish Green Bubble
                bubble.className = "message-out relative bg-[#d9fdd3] p-2 pl-3 rounded-lg shadow-sm max-w-[85%] min-w-[120px] cursor-pointer noselect active:bg-[#cbfcc2] transition-colors";
                bubble.dataset.id = entry.id;
                
                // Format Time
                const timeStr = entryDateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                // Content
                bubble.innerHTML = `
                    <p class="text-sm text-gray-800 whitespace-pre-wrap break-words leading-relaxed">${escapeHtml(entry.content)}</p>
                    <div class="flex justify-end items-center mt-1 space-x-1">
                        <span class="text-[10px] text-gray-500">${timeStr}</span>
                        <i class="fas fa-check-double text-[10px] text-[#53bdeb]"></i>
                    </div>
                `;

                // Long Press Events
                addLongPressEvent(bubble, entry.id, entry);

                bubbleWrapper.appendChild(bubble);
                chatContainer.appendChild(bubbleWrapper);
            });

            // Scroll to bottom
            setTimeout(() => {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }, 50);
        }

        // --- Input Handling ---
        function setDefaultDateTime() {
            const now = new Date();
            // Format to YYYY-MM-DDTHH:MM for datetime-local input
            const isoString = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
            entryDate.value = isoString;
        }

        function resetInput() {
            entryText.value = '';
            entryText.style.height = 'auto'; // Reset height
            setDefaultDateTime();
            
            // Reset Edit Mode
            editingId = null;
            sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
            sendBtn.classList.remove('bg-orange-500');
            sendBtn.classList.add('bg-[#008069]');
            cancelEditBtn.classList.add('hidden');
            editIndicator.classList.add('hidden');
        }

        function startEdit(entry) {
            editingId = entry.id;
            entryText.value = entry.content;
            entryDate.value = entry.timestamp;
            
            // UI Changes for Edit Mode
            sendBtn.innerHTML = '<i class="fas fa-check"></i>';
            sendBtn.classList.remove('bg-[#008069]');
            sendBtn.classList.add('bg-orange-500');
            cancelEditBtn.classList.remove('hidden');
            editIndicator.classList.remove('hidden');
            
            adjustTextareaHeight();
            entryText.focus();
            closeActionSheet();
        }

        // --- Event Listeners ---

        sendBtn.addEventListener('click', saveEntry);
        
        cancelEditBtn.addEventListener('click', resetInput);

        // Auto-resize Textarea
        function adjustTextareaHeight() {
            entryText.style.height = 'auto';
            entryText.style.height = entryText.scrollHeight + 'px';
        }
        entryText.addEventListener('input', adjustTextareaHeight);

        // --- Long Press / Action Sheet Logic ---

        function addLongPressEvent(element, id, entryData) {
            const handleStart = (e) => {
                // e.preventDefault(); // Do not prevent default immediately to allow scrolling
                longPressTimer = setTimeout(() => {
                    // Trigger long press
                    if (navigator.vibrate) navigator.vibrate(50); // Haptic feedback
                    openActionSheet(id, entryData);
                }, 600); // 600ms long press
            };

            const handleEnd = () => {
                clearTimeout(longPressTimer);
            };

            const handleMove = () => {
                clearTimeout(longPressTimer); // Cancel if scrolling
            };

            element.addEventListener('touchstart', handleStart, {passive: true});
            element.addEventListener('touchend', handleEnd);
            element.addEventListener('touchmove', handleMove);
            
            // For Desktop testing
            element.addEventListener('mousedown', handleStart);
            element.addEventListener('mouseup', handleEnd);
            element.addEventListener('mouseleave', handleEnd);
            element.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                // Context menu is effectively the long press on desktop, we handled it via mousedown/timer, 
                // but let's clear it just in case.
            });
        }

        function openActionSheet(id, entryData) {
            selectedEntryId = id;
            
            // Prep the Edit button to pass the specific entry data
            actionEdit.onclick = () => startEdit(entryData);
            actionDelete.onclick = () => confirmDelete(id);

            actionOverlay.classList.remove('hidden');
            // Small delay to allow display block to apply before opacity transition
            setTimeout(() => {
                actionOverlay.classList.remove('opacity-0');
                actionSheet.classList.remove('sheet-down');
                actionSheet.classList.add('sheet-up');
            }, 10);
        }

        function closeActionSheet() {
            actionSheet.classList.remove('sheet-up');
            actionSheet.classList.add('sheet-down');
            actionOverlay.classList.add('opacity-0');
            
            setTimeout(() => {
                actionOverlay.classList.add('hidden');
            }, 300);
        }

        function confirmDelete(id) {
            if(confirm("Are you sure you want to delete this entry?")) {
                deleteEntry(id);
            } else {
                closeActionSheet();
            }
        }

        actionOverlay.addEventListener('click', closeActionSheet);
        actionCancel.addEventListener('click', closeActionSheet);

        // --- Utils ---
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

    </script>
</body>
</html>

